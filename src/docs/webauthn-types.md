# FIDO2 / WebAuthn èªªæ˜Ž

## è§’è‰²èªªæ˜Ž

### 1ï¸âƒ£ RPï¼ˆRelying Partyï¼‰

- RP = ä½ å¯«çš„å¾Œç«¯ä¼ºæœå™¨ï¼ˆSpring Boot + Yubico libï¼‰
- å®ƒæ˜¯ã€Œä¿¡ä»»æ–¹ã€ï¼š
  - è² è²¬ç”Ÿæˆ challenge
  - å®šç¾©æ”¯æ´çš„æ¼”ç®—æ³•
  - é©—è­‰ç°½ç« 
  - å­˜å…¬é‘°

### 2ï¸âƒ£ ç€è¦½å™¨

- ç€è¦½å™¨æ˜¯ RP çš„ä»£ç†/ä¸­ä»‹
- ä»»å‹™ï¼š
  - æŽ¥æ”¶ RP å¾Œç«¯å‚³ä¾†çš„ `PublicKeyCredentialCreationOptions`ï¼ˆå« challengeã€excludeCredentials ç­‰ï¼‰
  - å‘¼å«æœ¬æ©Ÿ Authenticatorï¼ˆæ‰‹æ©Ÿ/ç¡¬é«”é‡‘é‘°ï¼‰
  - å›žå‚³ `PublicKeyCredential` çµ¦ RP
- ä¾‹å¦‚:ç€è¦½å™¨åªæ˜¯åŸ·è¡Œ RP çš„æŒ‡ä»¤ï¼Œæ‰€ä»¥ç•¶ RP æä¾› `excludeCredentials`ï¼Œç€è¦½å™¨å°±æœƒçŸ¥é“å“ªäº› credential ä¸èƒ½å†è¢«è¨»å†Š

### 3ï¸âƒ£ Authenticator

- çœŸæ­£ç”Ÿæˆé‡‘é‘°å°ã€ç°½ç½² challenge çš„é»‘ç›’
- ç€è¦½å™¨æŠŠ RP çš„è¦å‰‡å‚³çµ¦å®ƒï¼Œè®“å®ƒéµå®ˆ
- ä¾‹å¦‚:æ‰‹æ©Ÿçš„Authenticator

### ðŸ”¹ è§’è‰²ä¹‹é–“çš„æµç¨‹åœ–

```text
User                 RPï¼ˆç¶²ç«™/æœå‹™ï¼‰                Authenticator
 |                        |                              |
 |---- é–‹å§‹è¨»å†Š/ç™»å…¥ --->  |                              |
 |                        |---- ç”¢ç”Ÿ challenge --------> |
 |                        |<--- ç°½ç½²/å›žå‚³ publicKey ----  |
 |<--- è¨»å†ŠæˆåŠŸ/ç™»å…¥ OK -- |                              |
```

---

## è¨»å†Šæµç¨‹

### è¨»å†Šæµç¨‹åºåˆ—åœ– (Sequence Diagram)

(ä¾†æº https://ithelp.ithome.com.tw/articles/10374845)

![alt text](image.png)

---

## Yubico lib åŠ WebAuthn æ¨™æº–èªªæ˜Ž

ä»¥ä¸‹å…§å®¹æ•´ç†è‡ª Yubico lib åŠ WebAuthn æ¨™æº–ã€‚

### PublicKey

#### ç”¨ä¾†æè¿°ä¸€æ¬¡ FIDO2/WebAuthn è¨»å†Šè«‹æ±‚çš„å®Œæ•´è³‡è¨Šï¼ŒåŒ…æ‹¬ RPã€ä½¿ç”¨è€…ã€æŒ‘æˆ°ã€æ”¯æ´çš„å…¬é‘°æ¼”ç®—æ³•ã€Authenticator é¸æ“‡ã€attestation èˆ‡æ“´å……åŠŸèƒ½ï¼Œå‰ç«¯æ“šæ­¤ç”Ÿæˆæ†‘è­‰ã€‚

- **rp**: Relying Partyï¼Œæ‡‰ç”¨ç¨‹å¼å¾Œç«¯ä¼ºæœå™¨ã€‚RP çš„è§’è‰²æ˜¯ã€Œæœå‹™ç«¯ï¼Œä½ ä¿¡ä»»å®ƒä¾†é©—è­‰ä½¿ç”¨è€…èº«ä»½ã€ï¼Œå®ƒæä¾› challengeï¼ŒæŽ¥æ”¶ Authenticator ç°½ç½²çš„çµæžœï¼Œæ±ºå®šç™»å…¥æˆ–è¨»å†Šæ˜¯å¦æˆåŠŸã€‚

- **user**: ä½¿ç”¨è€…è³‡è¨Šã€‚

- **challenge**: æœ¬è³ªä¸Šæ˜¯ä¸€å€‹ä¸€æ¬¡æ€§éš¨æ©Ÿæ•¸ï¼ˆnonceï¼‰ã€‚ç€è¦½å™¨çš„ WebAuthn API è¦æ±‚ challenge æ˜¯ ArrayBuffer/Uint8Arrayï¼Œæ–¹ä¾¿åšåŠ å¯†ç°½ç« ï¼›å¾Œç«¯é€šå¸¸ç”¨å­—ä¸²å‚³è¼¸ï¼ˆJSONï¼‰ï¼Œæ‰€ä»¥éœ€è¦æŠŠ ByteArray è½‰æˆ Base64URLï¼Œä»¥ä¾¿ JSON / HTTP å‚³è¼¸ï¼Œç€è¦½å™¨æ”¶åˆ°å†è½‰å›ž ByteArray ç”¨æ–¼åŠ å¯†ç°½ç« ã€‚

- **pubKeyCredParams**: å‘Šè¨´ç€è¦½å™¨ï¼Authenticator ä½ æƒ³æ”¯æ´å“ªäº›å…¬é‘°é¡žåž‹å’Œæ¼”ç®—æ³•ã€‚ç€è¦½å™¨æœƒé¸æ“‡å…¶ä¸­ä¸€ç¨®æ”¯æ´çš„æ¼”ç®—æ³•ç”Ÿæˆé‡‘é‘°å°ï¼Œå›žå‚³çµ¦ RPã€‚

- **timeout**: é™åˆ¶æŒ‘æˆ°æœ‰æ•ˆæ™‚é–“ï¼Œé˜²æ­¢èˆŠ challenge è¢«é‡ç”¨ã€‚

- **excludeCredentials**: è®“ RP å¯ä»¥é¿å…é‡è¤‡è¨»å†Šæˆ–è¾¨è­˜ä½¿ç”¨è€…ç¾æœ‰è£ç½®ã€‚å‘Šè¨´ç€è¦½å™¨ã€Œé€™äº› credential å·²å­˜åœ¨ï¼Œè«‹ä¸è¦å†ç”¨å®ƒå€‘è¨»å†Šã€ï¼Œé¡žä¼¼ blacklistã€‚

- **authenticatorSelection**: æŒ‡å®šå¦‚ä½•é¸æ“‡ Authenticatorï¼ˆå¹³å° / è·¨å¹³å°ã€user verificationï¼‰ã€‚å¾Œç«¯è‹¥æœªè¨­å®šé»˜èªæ˜¯ PLATFORM â†’ åªç”¨ç€è¦½å™¨å…§å»º Authenticatorï¼›åŠ äº†æ‰èƒ½ä½¿ç”¨æ‰‹æ©ŸæŽƒ QR code ç™»å…¥ã€‚

- **attestation**: å‘Šè¨´ RP å¾Œç«¯å¸Œæœ› Authenticator å›žå‚³å“ªç¨® attestationï¼Œä¹Ÿå°±æ˜¯å¦‚ä½•è­‰æ˜Žé€™æŠŠé‡‘é‘°æ˜¯åˆæ³•ã€å—ä¿¡ä»»çš„è£ç½®ç”¢ç”Ÿçš„ã€‚
  - NONE: ä¸éœ€è¦ attestationï¼ŒRP ä¸é—œå¿ƒé‡‘é‘°ä¾†æºï¼ˆç·´ç¿’ / demo å¸¸ç”¨ï¼‰
  - INDIRECT: éœ€è¦ attestationï¼Œä½†ä¸è¦æ±‚ç‰¹å®š CA ç°½ç« 
  - DIRECT: éœ€è¦ attestationï¼Œä¸¦è¦æ±‚ç‰¹å®š CA ç°½ç« 
  - ENTERPRISE: ä¼æ¥­å…§éƒ¨ä½¿ç”¨çš„ attestation
- **extensions**: è¨»å†Šæ“´å……åŠŸèƒ½ã€‚
  - **appidExclude**: ç”¨é€”ï¼šä¸»è¦ç”¨åœ¨èˆŠç‰ˆ U2F å‘ä¸‹ç›¸å®¹ã€‚ç•¶ä½ é‚„æƒ³æ”¯æ´ U2F è£ç½®ï¼ˆèˆŠç¡¬é«”é‡‘é‘°ï¼‰æ™‚ï¼Œå¯ä»¥æŒ‡å®šä¸€å€‹ AppID æŽ’é™¤æ¸…å–®ã€‚ç¾ä»£ WebAuthn ç·´ç¿’ / YubiKey ä¸å¿…ä½¿ç”¨ã€‚
  - **credProps**: ç”¨é€”ï¼šè©¢å• Authenticator æ˜¯å¦æ”¯æ´ä¸€äº› credential å±¬æ€§ï¼Œä¾‹å¦‚æ˜¯å¦æ”¯æ´ã€Œresident keyã€ï¼ˆå¯å­˜æ”¾åœ¨ç¡¬é«”è£¡çš„ä½¿ç”¨è€…é‡‘é‘°ï¼‰ã€‚è‹¥ true â†’ Authenticator å›žå‚³ credProps çµæžœï¼ŒRP å¯æ±ºå®šæ˜¯å¦æŽ¥å—ã€‚
  - **uvm**: æ˜¯å¦è¦æ±‚å›žå‚³ä½¿ç”¨è€…é©—è­‰æ–¹å¼ï¼ˆUser Verification Methodsï¼‰ã€‚
  - **largeBlob**: å…§éƒ¨åž‹åˆ¥ï¼Œå¾Œç«¯ç”¨ï¼Œå‰ç«¯ä¸ç”¨å®šç¾©æˆ–å¯ç•™ç©ºã€‚
